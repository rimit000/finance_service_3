{% extends 'base.html' %}

{% block title %}내 상품, 이자 얼MOA?{% endblock %}

{% block content %}
<style>
  :root {

  --moa-green: #00C4A8;
  --moa-light: #8AE2BB;
  --moa-dark: #020715;

  --card-border-width: 1.5px;
  --card-border-radius: 0.5rem;
  --card-padding: 3rem;
  --card-bg: #FFFFFF;
  --card-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.1);
  --card-border-info: #CFCFCF;
  --card-border-success: #198754;
  --card-border-danger: #dc3545;

}
/* 타이틀----------------------------------------------------------------- */
  .moa-header {
    transform: translateY(-1cm);
    background: white;
    padding: 80px 20px 20px;
    text-align: center;
    font-family: 'NoonnuBasicGothic', sans-serif;
  }
  .moa-header .moa-bar {
    width: 53px;
    height: 10px;
    background-color: var(--moa-light);
    margin: 0 auto 30px;
  }
  .moa-header h1 {
    font-size: 4rem;
    font-weight: 700;
    color: var(--moa-green);
    letter-spacing: 1.5px;
  }
  .moa-header h1 span {
    color: var(--moa-light);
  }
  .moa-header p {
    font-size: 1.5rem;
    color: #717171;
    margin-top: 10px;
    letter-spacing: 1.1px;
  }

/* 탭메뉴 ----------------------------------------------------------------- */

  .nav-tabs {
    transform: translateY(-1cm);
    justify-content: center;
    border-bottom: none;
    white-space: nowrap;     
    font-family: 'NoonnuBasicGothic', sans-serif;
    /* overflow-x: auto; */
  }
  .nav-tabs .nav-link {
    color: #717171;
    font-size: 1.5rem;
    border: none;
    white-space: nowrap;     
    padding: 0.5rem 7.5rem;
  }
  .nav-tabs .nav-link.active {
    color: var(--moa-green);
    border-bottom: 2px solid var(--moa-green);
  }

/* 입력 박스----------------------------------------------------------------- */

  .calc-card {
    width: auto !important;
    border-width: var(--card-border-width) !important;
    border-style: solid !important;
    border-radius: var(--card-border-radius) !important;
    background-color: var(--card-bg) !important;
    box-shadow: var(--card-shadow) !important;
  }
  .calc-card .card-body {
    padding: var(--card-padding) !important;
  }

  .calc-card .card-title {
    color: #251C1C !important;
    margin-bottom: 0.7cm;
    font-size: 1.8rem;
    font-family: 'NoonnuBasicGothic', sans-serif;
  }

  .calc-card.info { border-color: var(--card-border-info) !important; }

/* 계산하기 버튼----------------------------------------------------------------- */

  .btn-fill-dark {
    font-family: 'NoonnuBasicGothic', sans-serif;
    width: 90%;
    height: 45.5px;
    font-size: 25px;
    --bs-btn-bg: #8AE2BB;
    --bs-btn-border-color: none !important;
    --bs-btn-color: #020715;
    --bs-btn-hover-bg: #8AE2BB;
  }

/* 입력카드 반영 표 ----------------------------------------------------------------- */

  .calc-card + table,
  .calc-card + table + table {
    width: auto !important;
    max-width: 600px;
    margin: 2rem auto;
  }

  .result-table {
    width: auto !important;
    border-collapse:collapse;
    margin-top:2rem;
    font-size:1rem; font-family: 'NoonnuBasicGothic', sans-serif;
  }

  .result-table th, .result-table td {
    border:1px solid #ccc; padding:.5rem 1.5rem;
    text-align:center; white-space:nowrap; 
  }
  .result-table th { background:#e6e6e6; }
</style>

<!-- body 본문 내용 --------------------------------------------------------------------------------------------------------------->


<!-- 타이틀 -->
<div class="moa-header">
  <div class="moa-bar"></div>
  <h1><span>내 상품,</span> 이자 얼MOA?</h1>
  <p>내가 가진 금융 상품, 여기서 바로 이자 계산 끝!</p>
</div>

<!-- 탭 리스트 -->
<div class="container py-5" data-bs-theme="auto">
  <ul class="nav nav-tabs mb-4" id="calcTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="tab-simple" data-bs-toggle="tab" data-bs-target="#simple">예금</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="tab-compound-mature" data-bs-toggle="tab" data-bs-target="#compound-mature">적금 만기</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="tab-compound-monthly" data-bs-toggle="tab" data-bs-target="#compound-monthly">적금 월 불입</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="tab-loan" data-bs-toggle="tab" data-bs-target="#loan">대출</button>
    </li>
  </ul>

<!-- 탭 내용 -->
<div class="tab-content">
    
<!-- 01. 예금 -->
    <div class="tab-pane fade show active" id="simple">
      <div class="row justify-content-center">
        <div class="col-md-6">

<!-- 01. 예금 - 콘텐츠 -->
          <div class="card calc-card info" >
            <div class="card-body">
              <h4 class="card-title text-right">예금 계산기</h4>
              <form id="simpleInterestForm" class="mb-4">
                <div class="mb-3">
                  <label for="simple-principal">예치 금액(원)</label>
                  <input type="number" id="simple-principal" name="principal" class="form-control" min="0">
                </div>
                <div class="mb-3">
                  <label for="simple-rate">연 이자율(%)</label>
                  <input type="number" id="simple-rate" name="rate" class="form-control" step="0.01" min="0">
                </div>
                <div class="mb-3">
                  <label for="simple-months">예금 기간(개월)</label>
                  <input type="number" id="simple-months" name="months" class="form-control" min="0">
                </div>
                <button type="button" class="btn btn-info btn-fill-dark d-block mx-auto d-block mx-auto" onclick="depositCal()">계산하기</button>
              </form>
            </div>
          </div>
<!-- 01. 예금 - 요약 테이블블 -->
               <table class="table table-bordered text-center mx-auto mb-4" style="width:auto; max-width:600px;">
                <thead><tr>
                  <th>예치금액(원)</th><th>예치기간</th><th>예금금리</th>
                </tr></thead>
                <tbody><tr>
                  <td id="summaryPrincipal">—</td>
                  <td id="summaryMonths">—</td>
                  <td id="summaryRate">—</td>
                </tr></tbody>
              </table>
<!-- 01. 예금 - 결과 테이블 -->
              <table class="result-table ms-auto mb-4" style="width:auto; max-width:600px;">
                <thead><tr>
                  <th>구분</th><th>월납입액 (원)</th><th>이자(세전, 원)</th><th>이자(세후, 원)</th><th>만기지급액(원)</th>
                </tr></thead>
                <tbody>
                  <tr>
                    <td>일반 (<span id="taxNormalRate">15.4</span>%)</td>
                    <td id="normalPrincipal">0</td>
                    <td id="normalInterestBefore">0</td>
                    <td id="normalInterestAfter">0</td>
                    <td id="normalMature">0</td>
                  </tr>
                  <tr>
                    <td>비과세 (0.0%)</td>
                    <td id="nonePrincipal">0</td>
                    <td id="noneInterestBefore">0</td>
                    <td id="noneInterestAfter">0</td>
                    <td id="noneMature">0</td>
                  </tr>
                </tbody>
              </table>
        </div>
      </div>
    </div>


<!-- 02. 적금 만기 -->
  <div class="tab-pane fade" id="compound-mature" role="tabpanel" aria-labelledby="tab-compound-mature">
    <div class="row justify-content-center">
      <div class="col-md-6">

<!-- 02. 적금 만기 - 콘텐츠 -->
          <div class="card calc-card info">
            <div class="card-body">
              <h4 class="card-title text-right">적금 만기 계산</h4>
              
              <form id="compoundMatureForm" class="mb-4">
                <div class="mb-3">
                  <label for="compound-monthly-deposit">월 납입액(원)</label>
                  <input type="number" id="compound-monthly-deposit" name="monthly" class="form-control" min="0"/>
                </div>
                
                <div class="mb-3">
                  <label for="compound-rate">연 이자율(%)</label>
                  <input type="number" id="compound-rate" name="rate" class="form-control" step="0.01" min="0"/>
                </div>
                
                <div class="mb-3">
                  <label for="compound-months">목표 기간(개월)</label>
                  <input type="number" id="compound-months" name="months" class="form-control" min="0" />
                </div>      
                <button type="button" class="btn btn-info btn-fill-dark d-block mx-auto" onclick="SavingsCal()">계산하기</button>
              
              </form>
            </div>
          </div>

<!-- 02. 적금 만기 - 요약 테이블 -->
                <table class="table table-bordered text-center mx-auto mb-4" style="width:auto; max-width:600px;">
                  <thead>
                    <tr>
                      <th>월납입액(원)</th>
                      <th>목표 기간</th>
                      <th>연 이자율</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td id="summaryCompoundPrincipal">—</td>
                      <td id="summaryCompoundMonths">—</td>
                      <td id="summaryCompoundRate">—</td>
                    </tr>
                  </tbody>
                </table>

<!-- 02. 적금 만기 - 결과 테이블 -->
                <table class="result-table">
                  <thead>
                    <tr>
                      <th>구분</th>
                      <th>월납입액 합계(원)</th>
                      <th>이자(세전, 원)</th>
                      <th>이자(세후, 원)</th>
                      <th>만기지급액(원)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>일반 (<span id="compoundTaxRate">15.4</span>%)</td>
                      <td id="compoundNormalPrincipal">0</td>
                      <td id="compoundInterestBefore">0</td>
                      <td id="compoundInterestAfter">0</td>
                      <td id="compoundMature">0</td>
                    </tr>
                    <tr>
                      <td>비과세 (0.0%)</td>
                      <td id="compoundNonePrincipal">0</td>
                      <td id="compoundNoneInterestBefore">0</td>
                      <td id="compoundNoneInterestAfter">0</td>
                      <td id="compoundNoneMature">0</td>
                    </tr>
                  </tbody>
                </table>

      </div>
    </div>
  </div>



  <!-- 03. 적금 월 불입 -->
  <div class="tab-pane fade" id="compound-monthly" role="tabpanel" aria-labelledby="tab-compound-monthly">
    <div class="row justify-content-center">
      <div class="col-md-6">

  <!-- 03. 적금 월 불입 - 콘텐츠 -->
        <div class="card calc-card info">
          <div class="card-body">
            <h4 class="card-title text-right">적금 월불입 계산</h4>
            
            <form id="compoundMonthlyForm" class="mb-4">
              <div class="mb-3">
                <label for="monthly-target">만기 목표 금액(원)</label>
                <input type="number" id="monthly-target" name="target" class="form-control" min="0"/>
              </div>
              
              <div class="mb-3">
                <label for="monthly-rate">연 이자율(%)</label>
                <input type="number" id="monthly-rate" name="rate" class="form-control" step="0.01" min="0"/>
              </div>

              <div class="mb-3">
                <label for="monthly-months">목표 기간(개월)</label>
                <input type="number" id="monthly-months" name="months" class="form-control" min="0"/>
              </div>

              <button type="button" class="btn btn-info btn-fill-dark d-block mx-auto" onclick="SavingsGoal()">계산하기</button>
            </form>
          </div>
        </div>

  <!-- 03. 적금 월 불입 - 요약표 -->
          <table class="table table-bordered text-center mx-auto mb-4" style="width:auto; max-width:600px;">
            <thead>
              <tr>
                <th>만기 목표(원)</th>
                <th>목표 기간</th>
                <th>연 이자율(%)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td id="summaryMonthlyTarget">—</td>
                <td id="summaryMonthlyMonths">—</td>
                <td id="summaryMonthlyRate">—</td>
              </tr>
            </tbody>
          </table>

  <!-- 03. 적금 월 불입 - 결과표 -->
          <table class="result-table ms-auto mb-4" style="width:auto; max-width:600px;">
            <thead>
              <tr>
                <th>구분</th>
                <th>필요월납입액(원)</th>
                <th>투자원금(원)</th>
                <th>이자(세전, 원)</th>
                <th>이자(세후, 원)</th>
                <th>만기지급액(원)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>일반 (<span id="compoundMonthlyTaxRate">15.4</span>%)</td>
                <td id="compoundMonthlyDeposit">0</td>
                <td id="compoundMonthlyTotalDeposit">0</td>
                <td id="compoundMonthlyInterestBefore">0</td>
                <td id="compoundMonthlyInterestAfter">0</td>
                <td id="compoundMonthlyMature">0</td>
              </tr>
              <tr>
                <td>비과세 (0.0%)</td>
                <td id="compoundMonthlyNoneDeposit">0</td>
                <td id="compoundMonthlyNoneTotalDeposit">0</td>
                <td id="compoundMonthlyNoneInterestBefore">0</td>
                <td id="compoundMonthlyNoneInterestAfter">0</td>
                <td id="compoundMonthlyNoneMature">0</td>
              </tr>
            </tbody>
          </table>
      </div>
    </div>
  </div>

<!-- 04. 대출 -->
  <div class="tab-pane fade" id="loan" role="tabpanel" aria-labelledby="tab-loan">
  <div class="row justify-content-center">
    <div class="col-md-6">

<!-- 04. 대출 - 콘텐츠-->
      <div class="card calc-card info mb-4">
        <div class="card-body">
          <h4 class="card-title text-right">대출 계산기</h4>
          
          <form id="loanForm">  
            <div class="mb-3">
              <label for="loan-amount" class="form-label">대출 원금(원)</label>
              <input type="number" id="loan-amount" name="loan" class="form-control" placeholder="대출 금액" min="0"/>
            </div>

            <div class="mb-3">
              <label for="loan-rate" class="form-label">연 이자율(%)</label>
              <input type="number" id="loan-rate" name="rate" class="form-control" placeholder="대출 금리" step="0.01" min="0"/>
            </div>

            <div class="mb-3">
              <label for="loan-grace">거치 기간(개월)</label>
              <input type="number" id="loan-grace" name="grace" class="form-control" min="0" value="0"/>
            </div>
            
            <div class="mb-3">
              <label for="loan-months" class="form-label">대출 기간(개월)</label>
              <input type="number" id="loan-months" name="months" class="form-control" placeholder="대출 기간" min="1"/>
            </div>
            
            <div class="mb-3">
              <label for="loan-type" class="form-label">상환 방식</label>
              <select id="loan-type" name="type" class="form-select">
                <option value="equal_payment">원리금균등</option>
                <option value="equal_principal">원금균등</option>
                <option value="bullet">만기일시상환</option>
              </select>
            </div>

            <button type="button" class="btn btn-info btn-fill-dark d-block mx-auto" onclick="calcLoan()"> 계산하기</button>
          </form>

        </div>
      </div>

<!-- 04. 대출 - 요약표-->
      <div class="mb-4">
        <table class="table table-bordered text-center">
          <thead class="table-light">
            <tr>
              <th>상환방식</th>
              <th>대출원금(원)</th>
              <th>대출기간</th>
              <th>거치 기간</th>
              <th>이자율</th>
              <th>월평균이자(원)</th>
              <th>총 이자액(원)</th>
              <th>원금+이자 합계(원)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="summaryLoanType">—</td>
              <td id="summaryLoanPrincipal">—</td>
              <td id="summaryLoanMonths">—</td>
              <td id="summaryLoanGrace">—</td>
              <td id="summaryLoanRate">—</td>
              <td id="summaryLoanMonthlyInt">—</td>
              <td id="summaryLoanTotalInt">—</td>
              <td id="summaryLoanTotalPay">—</td>
            </tr>
          </tbody>
        </table>
      </div>

<!-- 04. 대출 - 결과표-->
      <div id="loanScheduleWrapper">
        <table class="result-table">
          <thead>
            <tr>
              <th>회차</th>
              <th>상환금(원)</th>
              <th>납입원금(원)</th>
              <th>이자(원)</th>
              <th>누적납입원금(원)</th>
              <th>잔금(원)</th>
            </tr>
          </thead>
          <tbody id="loanScheduleBody"></tbody>
        </table>
      </div>

    </div>
  </div>
  </div>

<!-- --------------------------------------------------------------------------------자바 함수 -->
<!------------------------------------------------------------------------------------------------------------ 예금 -->
<script>
function depositCal() {
  const form       = document.forms['simpleInterestForm'];
  const principal  = parseFloat(form['principal'].value) || 0;
  const rateAnnual = (parseFloat(form['rate'].value) || 0) / 100;
  const months     = parseFloat(form['months'].value) || 0;

  // 요약
  document.getElementById('summaryPrincipal').innerText = principal.toLocaleString();
  document.getElementById('summaryMonths').innerText   = months + '개월';
  document.getElementById('summaryRate').innerText     = (rateAnnual*100).toFixed(2) + '%';

  // 이자 계산
  const totalInterest  = principal * rateAnnual * (months/12);
  const totalPreTax    = principal + totalInterest;
  const taxAmount      = totalInterest * 0.154;
  const totalAfterTax  = principal + (totalInterest - taxAmount);

  // 결과
  document.getElementById('normalPrincipal').innerText       = principal.toLocaleString();
  document.getElementById('normalInterestBefore').innerText = Math.round(totalInterest).toLocaleString();
  document.getElementById('normalInterestAfter').innerText  = Math.round(totalInterest - taxAmount).toLocaleString();
  document.getElementById('normalMature').innerText         = Math.round(totalAfterTax).toLocaleString();

  document.getElementById('nonePrincipal').innerText        = principal.toLocaleString();
  document.getElementById('noneInterestBefore').innerText  = Math.round(totalInterest).toLocaleString();
  document.getElementById('noneInterestAfter').innerText   = Math.round(totalInterest).toLocaleString();
  document.getElementById('noneMature').innerText          = Math.round(principal + totalInterest).toLocaleString();
}
</script>

<!------------------------------------------------------------------------------------------------------------ 적금 -->
<script>

function SavingsCal() {
  const form        = document.forms['compoundMatureForm'];
  const monthly     = parseFloat(form['monthly'].value) || 0;
  const annualRate  = parseFloat(form['rate'].value) || 0;
  const months      = parseFloat(form['months'].value) || 0;

  // 총 납입
  const totalDeposit = monthly * months;

  // 요약표
  document.getElementById('summaryCompoundPrincipal').innerText = monthly.toLocaleString();
  document.getElementById('summaryCompoundMonths').innerText   = months + '개월';
  document.getElementById('summaryCompoundRate').innerText     = annualRate.toFixed(2) + '%';

  // 이자 계산
  let totalInterest = 0;
  for (let i = 1; i <= months; i++) {
    const remainingMonths = months - i + 1; 
    const monthlyInterest = monthly * (annualRate / 100) * (remainingMonths / 12);
    totalInterest += monthlyInterest;
  }
  
  const taxAmount      = totalInterest * 0.154;
  const afterTaxInterest = totalInterest - taxAmount;
  const totalAfterTax  = totalDeposit + afterTaxInterest;

  // 결과표
  document.getElementById('compoundNormalPrincipal').innerText       = totalDeposit.toLocaleString();
  document.getElementById('compoundInterestBefore').innerText     = Math.round(totalInterest).toLocaleString();
  document.getElementById('compoundInterestAfter').innerText      = Math.round(afterTaxInterest).toLocaleString();
  document.getElementById('compoundMature').innerText            = Math.round(totalAfterTax).toLocaleString();

  document.getElementById('compoundNonePrincipal').innerText      = totalDeposit.toLocaleString();
  document.getElementById('compoundNoneInterestBefore').innerText = Math.round(totalInterest).toLocaleString();
  document.getElementById('compoundNoneInterestAfter').innerText  = Math.round(totalInterest).toLocaleString();
  document.getElementById('compoundNoneMature').innerText        = Math.round(totalDeposit + totalInterest).toLocaleString();
}
</script>

<!------------------------------------------------------------------------------------------------------------ 적금불 -->
<script>
function SavingsGoal() {
  const form       = document.forms['compoundMonthlyForm'];
  const target     = parseFloat(form['target'].value)    || 0;  
  const annualRate = parseFloat(form['rate'].value)      || 0;   
  const months     = parseInt(form['months'].value, 10)  || 0;  
  const taxRate    = 0.154;                                  

  if (months <= 0) return;

  // 총 이자율 합
  let totalInterestFactor = 0;
  for (let i = 1; i <= months; i++) {
    const remainingMonths = months - i + 1;
    totalInterestFactor += (annualRate / 100) * (remainingMonths / 12);
  }

  // 비과세 월납입액
  const depositExempt = target / (months + totalInterestFactor);

  // 일반(과세) 월납입액
  const depositGeneral = target / (months + totalInterestFactor * (1 - taxRate));

  
  const investGen      = depositGeneral * months;
  const interestGen    = depositGeneral * totalInterestFactor;
  const afterTaxGen    = interestGen * (1 - taxRate);
  const maturityGen    = investGen + afterTaxGen;

  const investEx       = depositExempt * months;
  const interestEx     = depositExempt * totalInterestFactor;
  const maturityEx     = investEx + interestEx;

  // 요약표 
  document.getElementById('summaryMonthlyTarget').innerText = target.toLocaleString();
  document.getElementById('summaryMonthlyMonths').innerText = months + '개월';
  document.getElementById('summaryMonthlyRate').innerText   = annualRate.toFixed(2) + '%';

  // 결과표
  // 일반
  document.getElementById('compoundMonthlyDeposit').innerText           = Math.round(depositGeneral).toLocaleString();
  document.getElementById('compoundMonthlyTotalDeposit').innerText      = Math.round(investGen).toLocaleString();
  document.getElementById('compoundMonthlyInterestBefore').innerText    = Math.round(interestGen).toLocaleString();
  document.getElementById('compoundMonthlyInterestAfter').innerText     = Math.round(afterTaxGen).toLocaleString();
  document.getElementById('compoundMonthlyMature').innerText           = Math.round(maturityGen).toLocaleString();

  // 비과세
  document.getElementById('compoundMonthlyNoneDeposit').innerText        = Math.round(depositExempt).toLocaleString();
  document.getElementById('compoundMonthlyNoneTotalDeposit').innerText   = Math.round(investEx).toLocaleString();
  document.getElementById('compoundMonthlyNoneInterestBefore').innerText = Math.round(interestEx).toLocaleString();
  document.getElementById('compoundMonthlyNoneInterestAfter').innerText  = Math.round(interestEx).toLocaleString();
  document.getElementById('compoundMonthlyNoneMature').innerText         = Math.round(maturityEx).toLocaleString();
}
</script>

<!------------------------------------------------------------------------------------------------------------ 대출 -->
<script>
function calcLoan() {
  const form    = document.forms['loanForm'];
  const P       = parseFloat(form['loan'].value)       || 0;    // 대출원금
  const annualR = parseFloat(form['rate'].value)       || 0;    // 연이자율(%)
  const months  = parseInt(form['months'].value, 10)   || 0;    // 대출기간(개월)
  const grace   = parseInt(form['grace'].value, 10)    || 0;    // 거치기간(개월)
  const type    = form['type'].value;                         // 상환 방식
  const r       = annualR / 12 / 100;                         // 월 이자율

  // 요약표
  document.getElementById('summaryLoanType').innerText      =
    type === 'equal_payment'   ? '원리금균등'
  : type === 'equal_principal' ? '원금균등'
  :                               '만기일시상환';
  document.getElementById('summaryLoanPrincipal').innerText = P.toLocaleString();
  document.getElementById('summaryLoanMonths').innerText    = months + '개월';
  document.getElementById('summaryLoanGrace').innerText     = grace + '개월';
  document.getElementById('summaryLoanRate').innerText      = annualR.toFixed(2) + '%';

  // 스케줄 테이블
  const tbody = document.getElementById('loanScheduleBody');
  tbody.innerHTML = '';
  
  let remaining = P;
  let accumPrincipal = 0;
  let totalInterest = 0;
  let monthlyPayment = 0;
  let monthlyPrincipal = 0;

  // 원리금 균등 상환
  let fixedMonthlyPayment = 0;
  if (type === 'equal_payment') {
    const n = months - grace;
    if (n > 0 && r > 0) {
      fixedMonthlyPayment = P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
    } else if (n > 0) {
      fixedMonthlyPayment = P / n;
    }
  }

  // 원금균등상환
  let fixedMonthlyPrincipal = 0;
  if (type === 'equal_principal') {
    const n = months - grace;
    if (n > 0) {
      fixedMonthlyPrincipal = P / n;
    }
  }

  // 스케줄 계산
  for (let i = 1; i <= months; i++) {
    let principal = 0;  // 원금상환액
    let interest = 0;   // 이자
    let payment = 0;    // 월 납입액

    if (type === 'bullet') {
      // 만기일시상환
      interest = remaining * r;
      if (i === months) {
        principal = remaining;
      } else {
        principal = 0;
      }
      payment = principal + interest;
      
    } else if (i <= grace) {
      // 거치기간: 이자만 납부
      interest = remaining * r;
      principal = 0;
      payment = interest;
      
    } else if (type === 'equal_principal') {
      // 원금균등상환: 고정 원금 + 변동 이자
      // 마지막 회차에서는 남은 잔액 전부 상환
      if (i === months) {
        principal = remaining;
      } else {
        principal = fixedMonthlyPrincipal;
      }
      interest = remaining * r;
      payment = principal + interest;
      
    } else if (type === 'equal_payment') {
      // 원리금균등상환: 고정 납입액 = 변동 원금 + 변동 이자
      interest = remaining * r;
      principal = fixedMonthlyPayment - interest;
      payment = fixedMonthlyPayment;
      
      if (i === months && Math.abs(principal - remaining) < 1) {
        principal = remaining;
        payment = principal + interest;
      }
    }

    // 잔액 업데이트
    remaining = Math.max(0, remaining - principal);
    accumPrincipal += principal;
    totalInterest += interest;

    // 요약표용
    if (type === 'bullet') {
      if (i === 1) {
        monthlyPayment = interest;
        monthlyPrincipal = 0;
      }
    } else if (i === grace + 1) {
      monthlyPayment = payment;
      monthlyPrincipal = principal;
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i}</td>
      <td>${Math.round(payment).toLocaleString()}</td>
      <td>${principal > 0 ? Math.round(principal).toLocaleString() : '0'}</td>
      <td>${Math.round(interest).toLocaleString()}</td>
      <td>${accumPrincipal > 0 ? Math.round(accumPrincipal).toLocaleString() : '-'}</td>
      <td>${Math.round(remaining).toLocaleString()}</td>
    `;
    tbody.appendChild(tr);
  }

  // 총 상환액
  const totalPayment = P + totalInterest;

  if (type === 'bullet') {
    document.getElementById('summaryLoanMonthlyInt').innerText = Math.round(P * r).toLocaleString();
  } else if (type === 'equal_principal') {
    document.getElementById('summaryLoanMonthlyInt').innerText = Math.round(fixedMonthlyPrincipal).toLocaleString();
  } else if (type === 'equal_payment') {
    document.getElementById('summaryLoanMonthlyInt').innerText = Math.round(fixedMonthlyPayment).toLocaleString();
  }
  
  document.getElementById('summaryLoanTotalInt').innerText   = Math.round(totalInterest).toLocaleString();
  document.getElementById('summaryLoanTotalPay').innerText   = Math.round(totalPayment).toLocaleString();
}
</script>
{% endblock %}
