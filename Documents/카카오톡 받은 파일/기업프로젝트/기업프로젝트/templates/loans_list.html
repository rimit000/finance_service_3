{% extends 'base.html' %}
{% block content %}

  <!-- 1) Bootstrap/Select2 CSS 로드 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='style.css') }}"
  />

  <!-- {# ----------------------------------------------------------- #}
       {# 2) 커스텀 CSS (화면 상단 헤더, 필터 카드, 테이블, 페이지네이션) #}
       {# ----------------------------------------------------------- #} -->
  <style>
    /* --------------------- 공통 CSS 변수 --------------------- */
    :root {
      --moa-green:       #8AE4D7;
      --moa-light:       #f8f9fa;
      --moa-dark-text:   #020715;
      --moa-border:      #E0E5F3;
      --moa-hover:       #E0E5F3;
    }

    /* -------------------- 상단 헤더 영역 -------------------- */
    .moa-header {
      transform: translateY(-1cm);
      background: white;
      text-align: center;
      padding: 20px;
      font-family: 'NoonnuBasicGothic', sans-serif;
    }
    .moa-header .moa-bar {
      width: 53px;
      height: 10px;
      background-color: var(--moa-green);
      margin: 20px auto 30px;
    }
    .moa-header h1 {
      font-size: 3.75rem; /* 60px */
      font-weight: 700;
      color: var(--moa-dark-text);
      letter-spacing: 1.2px;
      margin-bottom: 10px;
    }
    .moa-header p {
      font-size: 1.25rem;
      color: #717171;
      letter-spacing: 0.5px;
      margin: 0;
      font-weight: 400;
    }

    /* ------------------ 필터 카드(가로 바) ------------------ */
    .filter-card {
      background-color: #ffffff;
      border: 1px solid var(--moa-border);
      border-radius: 4px;
      box-shadow: 1px 1px 1px #0000000a, 0 2px 6px #131b320f;
      padding: 24px 24px;
      margin-bottom: 40px;
      font-family: 'NoonnuBasicGothic', sans-serif;
      font-weight: 300;
    }
    .filter-card .form-label {
      font-weight: 400;
      margin-bottom: 6px;
      color: var(--moa-dark-text);
    }
    .filter-card .form-select,
    .filter-card .form-control {
      border: 1px solid var(--moa-border);
      border-radius: 4px;
      height: 44px;
      font-size: 1rem;
    }
    .filter-card .form-control:focus,
    .filter-card .form-select:focus {
      border-color: var(--moa-green);
      box-shadow: 0 0 0 0.2rem rgba(0,196,139,0.25);
    }
    .filter-card .row {
      --bs-gutter-x: 8px;
      --bs-gutter-y: 4px;
    }

    .input-group-text {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      margin-left: -1px;
    }

    /* 대출 유형 필터 버튼 스타일 */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .loan-type-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .loan-type-buttons .btn {

      display: inline-block;
      width: 120px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #ffffff;
      box-shadow: 4px 4px 8px #D6DEE2;

      background-color: #ffffff;
      font-weight: 400;
      font-size: 16px;
      
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .loan-type-buttons .btn-success {

      border-color: #ffffff;
      color: #00C4A8;
    }

    .loan-type-buttons .btn-outline-success {
      border-color: #ffffff;
      color: #000000;
    }

    .loan-type-buttons .btn-outline-success:hover {
      background-color: #ffffff;
      border-color: #ffffff;
      color: #000000;
    }

    /* --------------------- 테이블 스타일 --------------------- */
    .moa-table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'NoonnuBasicGothic', sans-serif;
    }
    .moa-table thead th {
      background: #fff;
      border: none;
      border-bottom: 1px solid var(--moa-border);
      color: var(--moa-dark-text);
      font-weight: 300;
      padding: 12px 8px;
      text-align: center;
      vertical-align: middle;
      box-shadow: 1px 1px 1px #0000000a, 0 2px 6px #131b320f;
    }
    .moa-table thead th:first-child {
      border-left: 1px solid var(--moa-border);
      border-top-left-radius: 2px;
      border-bottom-left-radius: 2px;
    }
    .moa-table thead th:last-child {
      border-right: 1px solid var(--moa-border);
      border-top-right-radius: 2px;
      border-bottom-right-radius: 2px;
    }
    .moa-table tbody tr {
      background: #fff;
      border-bottom: 1px solid var(--moa-border);
      transition: background 0.1s ease-in-out;
    }
    .moa-table tbody tr:last-child {
      border-bottom: none;
    }
    .moa-table tbody tr:hover {
      background: var(--moa-hover);
    }
    .moa-table tbody td {
      padding: 12px 8px;
      vertical-align: middle;
      text-align: center;
    }
    .moa-table tbody tr td:nth-child(2),
    .moa-table tbody tr td:nth-child(3) {
      text-align: left;
      padding-left: 16px;
    }
    .moa-table img.bank-logo {
      height: 24px;
      margin-right: 6px;
      vertical-align: middle;
    }

    .btn-toggle {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      color: var(--moa-green) !important;
      padding: 4px 8px;
      font-size: 1rem;
      line-height: 1;
      cursor: pointer;
    }

    .collapse-row {
      background-color: #f8f9fa;
    }
    .collapse-row td {
      padding: 12px 16px;
      text-align: left;
      color: #444;
    }

    /* 페이지네이션 스타일 */
    #pagination-container {
      display: flex;
      justify-content: center;
      margin-top: 24px;
    }
    #pagination-container .page-btn {
      border: 1px solid #E0E5F3;
      color: #333;
      background-color: #fffdfd;
      padding: 6px 15px;
      margin: 0 4px;
      border-radius: 4px;
      font-size: 0.99rem;
      cursor: pointer;
    }
    #pagination-container .page-btn:hover {
      background-color: #C4F0DC;
      border-color: var(--moa-green);
      color: var(--moa-dark-text);
    }
    #pagination-container .page-btn.active {
      color: #333;
    }

    /* 대출 유형 설명 테이블 스타일 */
    .loan-type-explanation {
      margin-top: 20px;
      margin-bottom: 30px;
    }

    #loan-info-table {
      width: 100%;
      border-collapse: collapse;
      background-color: transparent;
    }

    #loan-info-table td,
    #loan-info-table th {
      border: none;
      padding: 10px;
      text-align: center;
      background-color: transparent;
    }



    .highlight-box {
      display: inline-block;
      width: 100px;
      height: 40px;
      line-height: 40px;
      text-align: center;
      border-radius: 10px;
      background-color: #ffffff;
      box-shadow: 4px 4px 8px #D6DEE2;
      color: #5B9279;
      font-weight: 600;
      font-size: 16px;
    }

    .small-left {
      font-size: 14px;
      text-align: left;
    }
  </style>

  <!-- body -->
  <div class="container mt-1 mb-5">
    <!-- 상단 헤더 -->
    <div class="moa-header mb-5">
      <div class="moa-bar"></div>
      <h1>{{ product_type }} 다 MOA</h1>
      <p>은행별 {{ product_type }} 상품을 손쉽게 비교해보세요</p>
    </div>

    <!-- 필터 카드(가로 바) -->
    <div class="filter-card mb-2">
      <div class="filter-bar">


        <!-- 필터 버튼들 -->
        <div class="loan-type-buttons">
          {% for option in ['전체', '비상금대출', '새희망홀씨', '무직자대출', '사잇돌', '햇살론'] %}
            <button type="button" class="btn {% if option in selected_types or (not selected_types and option == '전체') %}btn-success{% else %}btn-outline-success{% endif %}"
              onclick="applyFilter('{{ option }}')">
              {{ option }}
            </button>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- 대출 유형 설명 -->
    {% if selected_types and selected_types[0] != '전체' %}
      <div class="loan-type-explanation">
        {% if selected_types[0] == '비상금대출' %}
          <table class="dataframe loan-table" id="loan-info-table">
            <style>
                  #loan-info-table td:nth-child(1),
                  #loan-info-table th:nth-child(1) {
                    width: 14%;
                  }
                  #loan-info-table td:nth-child(2),
                  #loan-info-table th:nth-child(2) {
                    width: 36%;
                  }
                  #loan-info-table td:nth-child(3),
                  #loan-info-table th:nth-child(3) {
                    width: 14%;
                  }
                  #loan-info-table td:nth-child(4),
                  #loan-info-table th:nth-child(4) {
                    width: 36%;
                  }
            </style>
            <thead>
              <tr>
                <th><div class="highlight-box">소액 비상금</div></th>
                <th>금융권 비상금대출 상품</th>
                <th></th>
                <th>근로자 생활안정자금</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td></td>
                <td>서울보증보험(주) 보험증권 발급 가능한 자</td>
                <td><div class="highlight-box">대출 조건</div></td>
                <td>3개월 이상 재직 근로자,<br>일용근로자 : 90일 이내 45일 이상 근무</td>
              </tr>
              <tr>
                <td></td>
                <td>일반적으로 300~500만원</td>
                <td><div class="highlight-box">한도</div></td>
                <td>용도에 따라 200~2,000만원</td>
              </tr>
            </tbody>
          </table>

        {% elif selected_types[0] == '새희망홀씨' %}
          <table class="dataframe loan-table" id="loan-info-table">
            <style>
                  #loan-info-table td:nth-child(1),
                  #loan-info-table th:nth-child(1) {
                    width: 14%;
                  }
                  #loan-info-table td:nth-child(2),
                  #loan-info-table th:nth-child(2) {
                    width: 18%;
                  }
                  #loan-info-table td:nth-child(3),
                  #loan-info-table th:nth-child(3) {
                    width: 18%;
                  }
                  #loan-info-table td:nth-child(4),
                  #loan-info-table th:nth-child(4) {
                    width: 14%;
                  }
                  #loan-info-table td:nth-child(5),
                  #loan-info-table th:nth-child(5) {
                    width: 18%;
                  }
                  #loan-info-table td:nth-child(6),
                  #loan-info-table th:nth-child(6) {
                    width: 18%;
                  }
            </style>
            <thead>
              <tr>
                <th><div class="highlight-box">새희망홀씨</div></th>
                <th colspan="2">새희망홀씨 (1금융권)</th>
                <th></th>
                <th colspan="2">새희망홀씨 금리우대 항목</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td></td>
                <td>직장인</td>
                <td>사업자</td>
                <td><div class="highlight-box">분류</div></td>
                <td>연 0.5%P</td>
                <td>연 0.1%P</td>
              </tr>
              <tr>
                <td></td>
                <td colspan="2">3,500만원 이하(신용점수 무관),<br>4,500만원 이하(신용평점 하위 20%)</td>
                <td><div class="highlight-box">연 소득</div></td>
                <td rowspan="2"><div class="small-left">· 기초생활수급권자<br>· 한부모가정<br>· 다문화가정<br>· 만 60세 이상 부모 부양자<br>· 3자녀 이상 부양자<br>· 장애인</div></td>
                <td rowspan="2"><div class="small-left">· 청년층(만 29세 이하)<br>· 고령자(만 65세 이상)<br>· 금융교육이수자<br>· 일용직 근로자</div></td>
              </tr>
              <tr>
                <td></td>
                <td colspan="2">3,000~3,500만원</td>
                <td><div class="highlight-box">한도</div></td>
              </tr>
            </tbody>
          </table>

        {% elif selected_types[0] == '무직자대출' %}
          <table class="dataframe loan-table" id="loan-info-table">
            <style>
                  #loan-info-table td:nth-child(1),
                  #loan-info-table th:nth-child(1) {
                    width: 14%;
                  }
                  #loan-info-table td:nth-child(2),
                  #loan-info-table th:nth-child(2) {
                    width: 36%;
                  }
                  #loan-info-table td:nth-child(3),
                  #loan-info-table th:nth-child(3) {
                    width: 14%;
                  }
                  #loan-info-table td:nth-child(4),
                  #loan-info-table th:nth-child(4) {
                    width: 36%;
                  }
            </style>
            <thead>
              <tr>
                <th><div class="highlight-box">무직자 대출</div></th>
                <th>무직자 대출</th>
                <th></th>
                <th>무직자 대출 관련 정보</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td></td>
                <td>서울보증보험(주) 보험증권 발급 가능한 자,<br>신용 및 사기 이력 없는 자</td>
                <td><div class="highlight-box">대출 조건</div></td>
                <td rowspan="2"><div class="small-left">· 대개 '비상금대출'을 통해,<br>&nbsp;&nbsp;무직자도 소액으로 여신 서비스 활용하는 방식<br>· 상환 기간은 대체로 1년이지만, 특별한 사정이 없다면<br>&nbsp;&nbsp;만기 연장이 가능한 경우가 많음<br>· 회생, 파산, 면책 사실 없어야 함</div></td>
              </tr>
              <tr>
                <td></td>
                <td>50만원~300만원 한도</td>
                <td><div class="highlight-box">한도</div></td>
                <td></td>
              </tr>
            </tbody>
          </table>

        {% elif selected_types[0] == '사잇돌' %}
          <table class="dataframe loan-table" id="loan-info-table">
            <style>
                  #loan-info-table td:nth-child(1),
                  #loan-info-table th:nth-child(1) {
                    width: 14%;
                  }
                  #loan-info-table td:nth-child(2),
                  #loan-info-table th:nth-child(2) {
                    width: 18%;
                  }
                  #loan-info-table td:nth-child(3),
                  #loan-info-table th:nth-child(3) {
                    width: 18%;
                  }
                  #loan-info-table td:nth-child(4),
                  #loan-info-table th:nth-child(4) {
                    width: 14%;
                  }
                  #loan-info-table td:nth-child(5),
                  #loan-info-table th:nth-child(5) {
                    width: 18%;
                  }
                  #loan-info-table td:nth-child(6),
                  #loan-info-table th:nth-child(6) {
                    width: 18%;
                  }
            </style>
            <thead>
              <tr>
                <th><div class="highlight-box">사잇돌 대출</div></th>
                <th colspan="2">1금융권 사잇돌대출</th>
                <th></th>
                <th colspan="2">저축은행권 사잇돌2대출</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td></td>
                <td>직장인</td>
                <td>사업자</td>
                <td><div class="highlight-box">분류</div></td>
                <td>직장인</td>
                <td>사업자</td>
              </tr>
              <tr>
                <td></td>
                <td>1,500만원 이상</td>
                <td>1,000만원 이상</td>
                <td><div class="highlight-box">연 소득</div></td>
                <td>1,200만원 이상</td>
                <td>600만원 이상</td>
              </tr>
              <tr>
                <td></td>
                <td>3개월 이상</td>
                <td>6개월 이상</td>
                <td><div class="highlight-box">재직 기간</div></td>
                <td>5개월 이상</td>
                <td>4개월 이상</td>
              </tr>
              <tr>
                <td></td>
                <td colspan="2">100~2,000만원</td>
                <td><div class="highlight-box">한도</div></td>
                <td colspan="2">100~3,000만원</td>
              </tr>
            </tbody>
          </table>

        {% elif selected_types[0] == '햇살론' %}
          <table class="dataframe loan-table" id="loan-info-table">
            <style>
                  #loan-info-table td:nth-child(1),
                  #loan-info-table th:nth-child(1) {
                    width: 14%;
                  }
                  #loan-info-table td:nth-child(2),
                  #loan-info-table th:nth-child(2) {
                    width: 36%;
                  }
                  #loan-info-table td:nth-child(3),
                  #loan-info-table th:nth-child(3) {
                    width: 14%;
                  }
                  #loan-info-table td:nth-child(4),
                  #loan-info-table th:nth-child(4) {
                    width: 36%;
                  }
            </style>
            <thead>
              <tr>
                <th><div class="highlight-box">햇살론</div></th>
                <th>햇살론15</th>
                <th></th>
                <th>햇살론 최저신용자 특례보증</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td></td>
                <td>3,500만원 이하, 개인신용평점 하위 20%</td>
                <td><div class="highlight-box">연 소득</div></td>
                <td>4,500만원 이하, 개인신용평점 하위 10%</td>
              </tr>
              <tr>
                <td></td>
                <td>일반보증 : 3개월 이상 재직/사업<br>직접보증 : 3개월 미만 재직</td>
                <td><div class="highlight-box">재직 기간</div></td>
                <td>3개월 이상 재직/사업</td>
              </tr>
              <tr>
                <td></td>
                <td>최대 2,000만원</td>
                <td><div class="highlight-box">한도</div></td>
                <td>최대 1,000만원</td>
              </tr>
            </tbody>
          </table>
        {% endif %}
      </div>
    {% endif %}

    <!-- 상품 테이블 -->
    <div class="table-responsive">
      <table class="moa-table">
        <thead>
          <tr>  
            <th style="width:5%">번호</th>
            <th style="width:20%">금융회사명</th>
            <th style="width:30%">상품명</th>
            <th style="width:15%">금리</th>
            <th style="width:15%">대출한도</th>
            <th style="width:15%">자세히 보기</th>
          </tr>
        </thead>
        <tbody id="product-tbody"></tbody>
      </table>
      <div id="pagination-container"></div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 전역 변수 선언
    let selectedLoanType   = "전체";
    let currentPage        = 1;
    const itemsPerPage     = 15;
    let allProducts        = [];

    // 필터 적용 함수
    function applyFilter(type) {
      const url = new URL(window.location.href);
      url.searchParams.set('loanType', type);
      url.searchParams.delete('amount');
      window.location.href = url.toString();
    }

    // 선택된 대출 유형 가져오기
    function getSelectedType() {
      const activeBtn = document.querySelector('.loan-type-buttons .btn-success');
      return activeBtn ? activeBtn.innerText.trim() : '전체';
    }

    // 상품 불러오기
    function loadProducts() {

      selectedLoanType = getSelectedType();
      
      let query = `loanType=${encodeURIComponent(selectedLoanType)}`;

      fetch(`/api/{{ product_type_url }}?${query}`)
        .then(response => response.json())
        .then(result => {
          allProducts = result.products || [];
          currentPage  = 1;
          renderPage();
        })
        .catch(error => {
          console.error('Error loading products:', error);
          allProducts = [];
          renderPage();
        });
    }

    // 테이블 렌더링
    function renderPage() {
      const tbody      = document.getElementById("product-tbody");
      tbody.innerHTML  = "";

      const totalPages = Math.ceil(allProducts.length / itemsPerPage);
      const startIdx   = (currentPage - 1) * itemsPerPage;
      const pageItems  = allProducts.slice(startIdx, startIdx + itemsPerPage);

      if (pageItems.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4">
              조건에 맞는 상품이 없습니다.
            </td>
          </tr>`;
        renderPagination(totalPages);
        return;
      }

      pageItems.forEach((p, idx) => {
        const uid = `collapseRow${startIdx + idx}`;

        const rowHTML = `
          <tr>
            <td class="text-center">${startIdx + idx + 1}</td>
            <td>
              <img src="/static/${p.logo || 'default-logo.png'}" class="bank-logo me-2" alt="로고"/>
              ${p.금융회사명 || '정보 없음'}
            </td>
            <td>${p.상품명 || '정보 없음'}</td>
            <td>${p.금리 || '정보 없음'}</td>
            <td>${p.대출한도 || '정보 없음'}</td>
            <td class="text-center">
            <button
              class="btn-toggle"
              data-bs-target="#${uid}"
              aria-controls="${uid}"
              type="button"
            >▼</button>
            </td>
          </tr>`;
        
        const detailHTML = `
          <tr class="collapse" id="${uid}">
            <td colspan="6">
              <div class="bg-light p-3 rounded text-start">
                <p><strong>▶ 대출조건:</strong> ${p.대출조건 || "정보 없음"}</p>
                <p><strong>▶ 대출한도:</strong> ${p.대출한도 || "정보 없음"}</p>
                <p><strong>▶ 대출금리:</strong> ${p.금리 || "정보 없음"}</p>
                <p><strong>▶ 상환방법:</strong> ${p.상환방법 || "정보 없음"}</p>
                <p><strong>▶ 대출기간:</strong> ${p.대출기간 || "정보 없음"}</p>
                <p><strong>▶ 가입대상:</strong> ${p.가입대상 || "정보 없음"}</p>
                <p><strong>▶ 금융권:</strong> ${p.금융권 || "정보 없음"}</p>
                <div class="text-end mt-2">
                  <button
                    class="btn btn-sm btn-secondary"
                    onclick="bootstrap.Collapse.getOrCreateInstance(document.getElementById('${uid}')).hide()"
                  >닫기</button>
                </div>
              </div>
            </td>
          </tr>`;
        tbody.insertAdjacentHTML("beforeend", rowHTML + detailHTML);
      });

      renderPagination(totalPages);
    }

    // 페이지네이션
    function renderPagination(totalPages) {
      const container   = document.getElementById("pagination-container");
      container.innerHTML = "";
      if (totalPages <= 1) return;

      const prevBtn = document.createElement("button");
      prevBtn.textContent = "이전";
      prevBtn.className   = "page-btn me-1";
      prevBtn.disabled    = currentPage === 1;
      prevBtn.onclick     = () => {
        if (currentPage > 1) {
          currentPage--;
          renderPage();
        }
      };
      container.appendChild(prevBtn);

      const maxVisible = 5;
      const startPage  = Math.floor((currentPage - 1) / maxVisible) * maxVisible + 1;
      const endPage    = Math.min(startPage + maxVisible - 1, totalPages);
      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement("button");
        btn.textContent   = i;
        btn.className     = "page-btn mx-1" + (i === currentPage ? " active" : "");
        btn.onclick       = () => { currentPage = i; renderPage(); };
        container.appendChild(btn);
      }

      const nextBtn = document.createElement("button");
      nextBtn.textContent = "다음";
      nextBtn.className   = "page-btn ms-1";
      nextBtn.disabled    = currentPage === totalPages;
      nextBtn.onclick     = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderPage();
        }
      };
      container.appendChild(nextBtn);
    }

    // 문서 준비 후 이벤트 바인딩
    $(document).ready(() => {

      loadProducts();
    });

    // 열릴 때 ▲ 로
    document.addEventListener('DOMContentLoaded', () => {
      const tbody = document.getElementById('product-tbody');

      tbody.addEventListener('click', e => {
        const btn = e.target.closest('.btn-toggle');
        if (!btn) return;
        const targetSelector = btn.getAttribute('data-bs-target');
        const collapseEl = document.querySelector(targetSelector);
        bootstrap.Collapse.getOrCreateInstance(collapseEl).toggle();
      });


      document.addEventListener('shown.bs.collapse', e => {
        const btn = tbody.querySelector(`.btn-toggle[data-bs-target="#${e.target.id}"]`);
        if (btn) btn.textContent = '▲';
      });
      document.addEventListener('hidden.bs.collapse', e => {
        const btn = tbody.querySelector(`.btn-toggle[data-bs-target="#${e.target.id}"]`);
        if (btn) btn.textContent = '▼';
      });
    });
  </script>
{% endblock %}